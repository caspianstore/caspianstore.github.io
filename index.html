<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Caspian Store | Local Ultimate</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js"></script>
<style>
    :root {
        --bg: #242424;
        --card: #2c2c2e;
        --primary: #0A84FF;
        --accent: #30D158;
        --danger: #FF453A;
        --gold: #FFD700;
        --text: #FFFFFF;
        --text-sec: #A1A1A1;
        --glass: rgba(36, 36, 36, 0.95);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

    body {
        background-color: var(--bg);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Roboto, sans-serif;
        margin: 0;
        padding-bottom: 90px;
        overflow-x: hidden;
        user-select: none;
    }

    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }

    #start-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 9999; display: flex; flex-direction: column;
        justify-content: center; align-items: center; cursor: pointer;
    }

    header {
        position: fixed; top: 0; left: 0; right: 0;
        padding: 15px 20px; background: var(--glass);
        backdrop-filter: blur(10px); z-index: 100;
        border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;
    }
    .logo { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
    .id-badge { font-size: 12px; background: #333; padding: 5px 10px; border-radius: 20px; color: var(--text-sec); cursor: pointer; }
    .search-box { flex: 1; margin: 0 15px; }
    .search-box input { width: 100%; padding: 8px 12px; background: #333; border: none; border-radius: 10px; color: white; font-size: 12px; }

    .cat-scroll {
        display: flex; gap: 10px; overflow-x: auto; padding: 80px 15px 10px 15px;
        scrollbar-width: none;
    }
    .cat-scroll::-webkit-scrollbar { display: none; }
    .cat-item {
        background: #333; padding: 8px 16px; border-radius: 20px;
        white-space: nowrap; font-size: 13px; font-weight: 600; color: #ccc;
        transition: 0.3s; cursor: pointer;
    }
    .cat-item.active { background: var(--text); color: black; }

    .container { padding: 10px 15px; }
    
    .ad-card {
        background: var(--card); border-radius: 16px; margin-bottom: 20px;
        overflow: hidden; position: relative; border: 1px solid #333;
        animation: fadeIn 0.5s ease; cursor: pointer;
    }
    .ad-card.hot {
        border: 2px solid var(--gold);
        animation: pulse-gold 2s infinite;
    }
    .ad-card.sold { opacity: 0.5; pointer-events: none; }
    .hot-badge {
        position: absolute; top: 10px; right: 10px; background: var(--gold);
        color: black; font-weight: bold; font-size: 10px; padding: 4px 8px; border-radius: 8px; z-index: 2;
    }
    .sold-badge {
        position: absolute; top: 10px; right: 10px; background: var(--danger);
        color: white; font-weight: bold; font-size: 10px; padding: 4px 8px; border-radius: 8px; z-index: 2;
    }

    .slider-container { position: relative; width: 100%; height: 220px; background: #000; }
    .slider-img { width: 100%; height: 100%; object-fit: cover; display: none; }
    .slider-img.active { display: block; animation: fadeIn 0.3s; }
    .slider-btn {
        position: absolute; top: 50%; transform: translateY(-50%);
        background: rgba(0,0,0,0.5); color: white; border: none;
        padding: 10px; cursor: pointer; z-index: 2; border-radius: 50%;
    }
    .prev-btn { left: 10px; } .next-btn { right: 10px; }

    .ad-content { padding: 15px; }
    .ad-price { font-size: 20px; font-weight: 700; color: var(--accent); }
    .ad-title { font-size: 17px; margin: 5px 0; font-weight: 600; display: flex; align-items: center; gap: 5px; }
    .verified-icon { color: #1DA1F2; font-size: 14px; }
    
    .btn { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: 600; margin-top: 8px; cursor: pointer; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-gold { background: linear-gradient(135deg, #FFD700, #FFA500); color: black; }
    .btn-glass { background: rgba(255,255,255,0.1); color: white; }
    .btn-danger { background: rgba(255, 69, 58, 0.2); color: var(--danger); }
    .btn-mini { padding: 6px 10px; font-size: 11px; margin: 4px 4px 4px 0; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; }
    
    .action-row { display: flex; gap: 10px; }

    .fab {
        position: fixed; bottom: 30px; right: 20px; width: 55px; height: 55px;
        background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 500; font-size: 22px; color: white; cursor: pointer;
    }
    .support-fab {
        position: fixed; bottom: 30px; left: 20px; width: 50px; height: 50px;
        background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        z-index: 500; font-size: 20px; color: white; cursor: pointer;
    }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
        z-index: 2000; display: none; align-items: flex-end;
    }
    .modal-content {
        background: #1c1c1e; width: 100%; padding: 25px 20px 40px 20px;
        border-radius: 25px 25px 0 0; animation: slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        max-height: 90vh; overflow-y: auto;
    }
    .modal-handle { width: 40px; height: 5px; background: #444; margin: 0 auto 20px auto; border-radius: 10px; }

    input, select, textarea {
        width: 100%; background: #2c2c2e; border: 1px solid #333; padding: 15px;
        border-radius: 12px; color: white; margin-bottom: 10px; font-size: 16px;
    }

    #admin-login-box { display: none; margin-bottom: 15px; padding: 10px; background: #222; border-radius: 10px; }
    
    .ban-message { background: var(--danger); padding: 20px; text-align: center; color: white; font-size: 16px; }
    .user-profile { padding: 15px; background: #2c2c2e; border-radius: 12px; margin-bottom: 15px; }
    .user-profile h3 { margin: 0; }
    .user-profile p { margin: 5px 0; font-size: 12px; color: #aaa; }
    .loading { text-align: center; padding: 20px; color: #aaa; }
</style>
</head>
<body>

    <div id="start-screen" onclick="initApp()">
        <i class="fas fa-play-circle" style="font-size: 60px; color: #fff; margin-bottom: 20px;"></i>
        <div style="font-size: 20px; letter-spacing: 2px;">CASPIAN STORE</div>
        <div style="font-size: 12px; color: #666; margin-top: 10px;">Daxil olmaq √º√ß√ºn toxunun</div>
    </div>

    <div id="app" style="display: none;">
        <header>
            <div class="logo">CASPIAN</div>
            <div class="search-box">
                <input type="text" id="search-user" placeholder="ID il…ô axtar..." onkeyup="searchUser()">
            </div>
            <div class="id-badge" id="user-display" onclick="toggleAdminPanel()">ID: ...</div>
        </header>

        <div id="admin-login-box" class="modal-overlay" style="align-items: center; justify-content: center;">
            <div style="background: #222; padding: 20px; border-radius: 15px; width: 80%;">
                <h3>Admin Giri≈üi</h3>
                <input type="text" id="login-name" placeholder="Ad (Adm19)">
                <input type="password" id="login-pass" placeholder="Kod">
                <button class="btn btn-primary" onclick="attemptAdminLogin()">Giri≈ü</button>
                <button class="btn btn-glass" onclick="closeAdminLogin()">Baƒüla</button>
            </div>
        </div>

        <div class="cat-scroll">
            <div class="cat-item active" onclick="filterAds('all', this)">Son Elanlar</div>
            <div class="cat-item" onclick="filterAds('Pubg', this)">Pubg</div>
            <div class="cat-item" onclick="filterAds('Free Fire', this)">Free Fire</div>
            <div class="cat-item" onclick="filterAds('Brawl Stars', this)">Brawl Stars</div>
            <div class="cat-item" onclick="filterAds('Black Russia', this)">Black Russia</div>
            <div class="cat-item" onclick="filterAds('TikTok', this)">TikTok</div>
            <div class="cat-item" onclick="filterAds('Instagram', this)">Instagram</div>
        </div>

        <div class="container" id="ads-list"><div class="loading">Y√ºkl…ônir...</div></div>

        <div class="fab" onclick="openModal('addModal')"><i class="fas fa-plus"></i></div>
        <div class="support-fab" onclick="openModal('supportModal')"><i class="fas fa-headset"></i></div>
    </div>

    <div id="addModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-handle"></div>
            <h2>Yeni Elan</h2>
            <select id="new_cat">
                <option value="Pubg">Pubg Mobile</option>
                <option value="Free Fire">Free Fire</option>
                <option value="Brawl Stars">Brawl Stars</option>
                <option value="Black Russia">Black Russia</option>
                <option value="TikTok">TikTok</option>
                <option value="Instagram">Instagram</option>
            </select>
            <input type="text" id="new_title" placeholder="Ba≈ülƒ±q (m…ôs: 70 lvl, Full)">
            <input type="number" id="new_price" placeholder="Qiym…ôt (AZN)">
            <input type="tel" id="new_wp" placeholder="WhatsApp (m…ôs: 994501234567)">
            <textarea id="new_desc" rows="3" placeholder="∆ètraflƒ± m…ôlumat..."></textarea>
            
            <label style="font-size: 12px; color: #aaa;">≈û…ôkill…ôr (Maks 5 …ôd…ôd)</label>
            <input type="file" id="new_imgs" multiple accept="image/*">
            
            <button class="btn btn-primary" onclick="publishAd()">Payla≈ü</button>
            <button class="btn btn-glass" onclick="closeModal('addModal')">L…ôƒüv et</button>
        </div>
    </div>

    <div id="warningModal" class="modal-overlay">
        <div class="modal-content" style="border-top: 2px solid var(--danger);">
            <div class="modal-handle"></div>
            <h2 style="color: var(--danger)">‚ö†Ô∏è Dƒ∞QQ∆èT!</h2>
            <p style="color: #ccc; font-size: 14px; line-height: 1.5;">
                Siz birba≈üa satƒ±cƒ±ya yazƒ±rsƒ±nƒ±z.<br>
                Caspian Store, satƒ±cƒ± il…ô aranƒ±zda olan danƒ±≈üƒ±qlara v…ô √∂d…ôni≈ül…ôr…ô g√∂r…ô <b>m…ôsuliyy…ôt da≈üƒ±mƒ±r</b>.<br><br>
                T…ôhl√ºk…ôsizlik √º√ß√ºn <b>"Aracƒ± il…ô Al"</b> se√ßimini t√∂vsiy…ô edirik.
            </p>
            <div class="action-row">
                <button class="btn btn-glass" onclick="closeModal('warningModal')">Geri</button>
                <button class="btn btn-primary" id="confirm-seller-btn">Ba≈üa d√º≈üd√ºm, Yaz</button>
            </div>
        </div>
    </div>

    <div id="supportModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-handle"></div>
            <h2><i class="fas fa-headset"></i> D…ôst…ôk</h2>
            <button class="btn btn-primary" style="background: #25D366;" onclick="window.open('https://wa.me/994771048394', '_blank')">
                <i class="fab fa-whatsapp"></i> WhatsApp D…ôst…ôk
            </button>
            <button class="btn btn-primary" style="background: #0088cc;" onclick="window.open('https://t.me/mamedov7', '_blank')">
                <i class="fab fa-telegram-plane"></i> Telegram D…ôst…ôk
            </button>
            <button class="btn btn-glass" onclick="closeModal('supportModal')">Baƒüla</button>
        </div>
    </div>

    <div id="detailModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-handle"></div>
            <div id="detail-content"></div>
            <button class="btn btn-glass" onclick="closeModal('detailModal')">Baƒüla</button>
        </div>
    </div>

    <div id="userProfileModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-handle"></div>
            <div id="profile-content"></div>
            <button class="btn btn-glass" onclick="closeModal('userProfileModal')">Baƒüla</button>
        </div>
    </div>

    <div id="banListModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-handle"></div>
            <h2>üö´ Ban Listi</h2>
            <div id="ban-list-content"></div>
            <button class="btn btn-glass" onclick="closeModal('banListModal')">Baƒüla</button>
        </div>
    </div>

    <div id="hotPaymentModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-handle"></div>
            <h2>üí∞ HOT √ñd…ôni≈ü</h2>
            <p style="color: #aaa; font-size: 13px; margin-bottom: 15px;">Elanƒ±nƒ±zƒ± √∂n sƒ±raya √ß…ôkm…ôk √º√ß√ºn m√ºdd…ôt se√ßin:</p>
            <button class="btn btn-gold" onclick="purchaseHot(currentHotAdId, 24, 0.49)">24 Saat - 0.49‚Çº</button>
            <button class="btn btn-gold" onclick="purchaseHot(currentHotAdId, 48, 0.79)">48 Saat - 0.79‚Çº</button>
            <button class="btn btn-gold" onclick="purchaseHot(currentHotAdId, 72, 1.19)">72 Saat - 1.19‚Çº</button>
            <button class="btn btn-glass" onclick="closeModal('hotPaymentModal')">L…ôƒüv et</button>
        </div>
    </div>

    <div id="banReasonModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-handle"></div>
            <h2>üö´ IP Ban Et</h2>
            <input type="text" id="ban-user-id" placeholder="Banlayacaƒüƒ±nƒ±z User ID">
            <textarea id="ban-reason" rows="3" placeholder="Ban sebebini yazƒ±n (istifad…ô√ßi g√∂rec…ôk)..."></textarea>
            <button class="btn btn-danger" onclick="confirmBanUser()">Banlancƒ±</button>
            <button class="btn btn-glass" onclick="closeModal('banReasonModal')">L…ôƒüv et</button>
        </div>
    </div>

    <div id="music-player" style="position:fixed; top:-1000px; opacity:0;"></div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyAHlsRmfc2DxAPMu0FCMfv00B_CL9a7C-c",
        authDomain: "caspian-web.firebaseapp.com",
        projectId: "caspian-web",
        storageBucket: "caspian-web.firebasestorage.app",
        messagingSenderId: "889257417792",
        appId: "1:889257417792:web:146d6afbdcc4427cdfd3a5",
        databaseURL: "https://caspian-web-default-rtdb.europe-west1.firebasedatabase.app"
    };

    // Firebase Initialize
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let currentUser = JSON.parse(localStorage.getItem('caspian_user_local')) || null;
    let allAds = [];
    let bannedIPs = [];
    let currentHotAdId = null;
    let userIP = null;

    function getUserIP() {
        return 'IP_' + Math.random().toString(36).substr(2, 9).toUpperCase();
    }

    function isIPBanned(ip) {
        return bannedIPs.some(ban => ban.ip === ip);
    }

    function getBanReason(ip) {
        const ban = bannedIPs.find(b => b.ip === ip);
        return ban ? ban.reason : null;
    }

    // Firebase-d…ôn elanlarƒ± oxu (Real-time)
    function loadAdsFromFirebase() {
        database.ref('ads').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                allAds = Object.values(data).map(ad => ({
                    ...ad,
                    id: ad.id
                }));
            } else {
                allAds = [];
            }
            renderAds(allAds);
        });
    }

    // Firebase-d…ôn ban listini oxu
    function loadBansFromFirebase() {
        database.ref('bans').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                bannedIPs = Object.values(data);
            } else {
                bannedIPs = [];
            }
        });
    }

    function initApp() {
        userIP = getUserIP();

        loadBansFromFirebase();

        setTimeout(() => {
            if (isIPBanned(userIP)) {
                const reason = getBanReason(userIP);
                document.body.innerHTML = `
                    <div class="ban-message">
                        <h2>üö´ Sizin ID'niz Banlanƒ±b</h2>
                        <p style="margin: 20px 0; font-size: 14px;">${reason || 'S…ôb…ôb a√ßƒ±klanmamƒ±≈üdƒ±r.'}</p>
                        <p style="font-size: 12px; color: #ccc;">Admin desteyi i√ßin: wa.me/994771048394</p>
                    </div>
                `;
                return;
            }

            if (!currentUser) {
                const newId = Math.floor(100000 + Math.random() * 900000).toString();
                currentUser = { 
                    id: newId, 
                    name: "User", 
                    isAdmin: false, 
                    isBanned: false, 
                    isVerified: false,
                    ip: userIP,
                    createdAt: new Date().toISOString()
                };
                localStorage.setItem('caspian_user_local', JSON.stringify(currentUser));
            }

            if (currentUser.isBanned) {
                alert("Sƒ∞Zƒ∞N ID BANLANIB!");
                document.body.innerHTML = "<h1 style='color:white; text-align:center; margin-top:50px;'>BANLANDINIZ</h1>";
                return;
            }

            // Musiqi
            const playlist = ['rVkCOfUDCaM', 'PfnJ7lRX0pY', 'zJXhT4sVlK0'];
            const randomVid = playlist[Math.floor(Math.random() * playlist.length)];
            document.getElementById('music-player').innerHTML = 
                `<iframe width="1" height="1" src="https://www.youtube.com/embed/${randomVid}?autoplay=1&loop=1&playlist=${playlist.join(',')}" frameborder="0" allow="autoplay"></iframe>`;

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            updateUserUI();
            loadAdsFromFirebase();
        }, 500);
    }

    function updateUserUI() {
        let badgeHTML = `ID: #${currentUser.id}`;
        if (currentUser.isAdmin) badgeHTML += ` <span style="color:red">(ADMIN)</span>`;
        else if (currentUser.isVerified) badgeHTML += ` <i class="fas fa-check-circle" style="color:#1DA1F2"></i>`;
        document.getElementById('user-display').innerHTML = badgeHTML;
    }

    async function publishAd() {
        const fileInput = document.getElementById('new_imgs');
        if (fileInput.files.length === 0) return alert("∆èn azƒ± 1 ≈ü…ôkil se√ßin!");
        if (fileInput.files.length > 5) return alert("Maksimum 5 ≈ü…ôkil!");

        const imagesBase64 = [];
        for (let file of fileInput.files) {
            const base64 = await toBase64(file);
            imagesBase64.push(base64);
        }

        const newAdId = Date.now().toString();
        const newAd = {
            id: newAdId,
            sellerId: currentUser.id,
            sellerName: currentUser.name,
            sellerVerified: currentUser.isVerified,
            cat: document.getElementById('new_cat').value,
            title: document.getElementById('new_title').value,
            price: document.getElementById('new_price').value,
            wp: document.getElementById('new_wp').value,
            desc: document.getElementById('new_desc').value,
            images: imagesBase64,
            isHot: false,
            hotExpire: null,
            isSold: false,
            timestamp: Date.now()
        };

        if(!newAd.title || !newAd.price || !newAd.wp) return alert("Xanalarƒ± doldurun!");

        // Firebase-…ô yazƒ±
        database.ref('ads/' + newAdId).set(newAd).then(() => {
            alert("Elan payla≈üƒ±ldƒ±! ‚úÖ");
            closeModal('addModal');
            document.getElementById('new_title').value = "";
            document.getElementById('new_price').value = "";
            document.getElementById('new_wp').value = "";
            document.getElementById('new_desc').value = "";
            document.getElementById('new_imgs').value = "";
        }).catch(err => alert("X…ôta: " + err.message));
    }

    function renderAds(ads) {
        const list = document.getElementById('ads-list');
        list.innerHTML = "";
        
        const sortedAds = ads.sort((a, b) => {
            if (a.isHot && !b.isHot) return -1;
            if (!a.isHot && b.isHot) return 1;
            return b.timestamp - a.timestamp;
        });

        sortedAds.forEach(ad => {
            if (ad.isSold) return;
            
            const isHot = ad.isHot ? 'hot' : '';
            const hotBadge = ad.isHot ? '<div class="hot-badge">üî• HOT</div>' : '';
            const verifiedBadge = ad.sellerVerified ? '<i class="fas fa-check-circle verified-icon"></i>' : '';
            
            let imgsHTML = "";
            ad.images.forEach((img, idx) => {
                imgsHTML += `<img src="${img}" class="slider-img ${idx === 0 ? 'active' : ''}" data-idx="${idx}">`;
            });

            let ownerPanel = "";
            if (currentUser.id === ad.sellerId && !currentUser.isAdmin) {
                ownerPanel = `
                    <div style="background:#000; padding:10px; margin-top:10px; border-radius:10px;">
                        <small style="color:#FFD700">Sƒ∞Z SADƒ∞C∆è:</small><br>
                        <button class="btn-mini" onclick="deleteAd('${ad.id}')">‚ùå Sil</button>
                        <button class="btn-mini" onclick="openHotPayment('${ad.id}')">üí∞ HOT Et</button>
                        <button class="btn-mini" onclick="markAsSold('${ad.id}')">‚úÖ Satƒ±ldƒ±</button>
                    </div>`;
            }

            let adminPanel = "";
            if (currentUser.isAdmin) {
                adminPanel = `
                    <div style="background:#000; padding:10px; margin-top:10px; border-radius:10px;">
                        <small style="color:red">ADMIN PANEL:</small><br>
                        <button class="btn-mini" onclick="toggleHot('${ad.id}')">üî• Hot</button>
                        <button class="btn-mini" onclick="markAsSold('${ad.id}')">‚úÖ Satƒ±ldƒ±</button>
                        <button class="btn-mini" onclick="deleteAd('${ad.id}')">‚ùå Sil</button>
                        <button class="btn-mini" onclick="openBanModal('${ad.sellerId}')">üö´ Ban</button>
                    </div>`;
            }

            list.innerHTML += `
                <div class="ad-card ${isHot}" id="ad-${ad.id}" onclick="showAdDetail('${ad.id}')">
                    ${hotBadge}
                    <div class="slider-container" id="slider-${ad.id}" onclick="event.stopPropagation()">
                        ${imgsHTML}
                        ${ad.images.length > 1 ? `
                            <button class="slider-btn prev-btn" onclick="slideImage('${ad.id}', -1)"><i class="fas fa-chevron-left"></i></button>
                            <button class="slider-btn next-btn" onclick="slideImage('${ad.id}', 1)"><i class="fas fa-chevron-right"></i></button>
                        ` : ''}
                    </div>
                    <div class="ad-content" onclick="event.stopPropagation()">
                        <div style="font-size:12px; color:#888; display:flex; justify-content:space-between;">
                            <span>${ad.cat}</span> <span style="cursor:pointer; color:#0A84FF;" onclick="searchUserById('${ad.sellerId}')">ID: #${ad.sellerId}</span>
                        </div>
                        <h3 class="ad-title">${ad.title}</h3>
                        <div class="ad-price">${ad.price} AZN</div>
                        <p style="font-size:12px; color:#aaa;">Satƒ±cƒ±: <span style="cursor:pointer; color:#0A84FF;" onclick="showUserProfile('${ad.sellerId}')">${ad.sellerName}</span> ${verifiedBadge}</p>
                        
                        <div class="action-row" style="display: ${currentUser.id === ad.sellerId ? 'none' : 'flex'}">
                            <button class="btn btn-glass" onclick="warningSeller('${ad.wp}', '${ad.title}', '${ad.sellerId}'); event.stopPropagation();">Satƒ±cƒ±ya Yaz</button>
                            <button class="btn btn-gold" onclick="contactAraci('${ad.id}', '${ad.wp}', '${ad.title}', '${ad.price}', '${ad.sellerId}'); event.stopPropagation();">Aracƒ± il…ô Al</button>
                        </div>
                        ${ownerPanel}
                        ${adminPanel}
                    </div>
                </div>
            `;
        });
    }

    window.slideImage = function(adId, dir) {
        const container = document.getElementById(`slider-${adId}`);
        const imgs = container.querySelectorAll('.slider-img');
        let activeIdx = 0;
        imgs.forEach((img, i) => { if(img.classList.contains('active')) activeIdx = i; });
        
        imgs[activeIdx].classList.remove('active');
        let newIdx = activeIdx + dir;
        if (newIdx < 0) newIdx = imgs.length - 1;
        if (newIdx >= imgs.length) newIdx = 0;
        imgs[newIdx].classList.add('active');
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    window.filterAds = function(cat, el) {
        document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        if (cat === 'all') renderAds(allAds);
        else renderAds(allAds.filter(a => a.cat === cat));
    }

    window.contactAraci = function(id, sellerWp, title, price, sellerId) {
        const msg = `Salam Caspian Store Aracƒ±. Bu elanƒ± almaq ist…ôyir…ôm:%0A
        üÜî *Elan ID:* ${id}%0A
        üë§ *Satƒ±cƒ± ID:* ${sellerId}%0A
        üì± *Satƒ±cƒ± N√∂mr…ôsi:* ${sellerWp}%0A
        üéÆ *Elan:* ${title}%0A
        üí∞ *Qiym…ôt:* ${price} AZN`;
        window.open(`https://wa.me/994771048394?text=${msg}`, '_blank');
    }

    window.warningSeller = function(wp, title, sellerId) {
        const btn = document.getElementById('confirm-seller-btn');
        btn.onclick = function() {
            const msg = `Salam, Caspian Store-dan yazƒ±ram. Bu elanla maraqlanƒ±ram:%0A
            üÜî *ID:* ${sellerId}%0A
            üéÆ *Elan:* ${title}`;
            window.open(`https://wa.me/${wp}?text=${msg}`, '_blank');
            closeModal('warningModal');
        };
        openModal('warningModal');
    }

    window.deleteAd = function(id) {
        const ad = allAds.find(a => a.id === id);
        if (currentUser.id !== ad.sellerId && !currentUser.isAdmin) return alert("Yalnƒ±z sahibi v…ô admin sil…ôbil…ôr!");
        if (!confirm("Silirs…ôn?")) return;
        database.ref('ads/' + id).remove().then(() => {
            alert("Elan silindi!");
        });
    }

    window.toggleHot = function(id) {
        if (!currentUser.isAdmin) return alert("Yalnƒ±z admin!");
        const ad = allAds.find(a => a.id === id);
        if (ad) {
            database.ref('ads/' + id).update({
                isHot: !ad.isHot,
                hotExpire: !ad.isHot ? new Date().getTime() + (24 * 60 * 60 * 1000) : null
            });
        }
    }

    window.markAsSold = function(id) {
        const ad = allAds.find(a => a.id === id);
        if (currentUser.id !== ad.sellerId && !currentUser.isAdmin) return alert("Yalnƒ±z sahibi v…ô admin!");
        if (!confirm("Elanƒ± Satƒ±ldƒ± i≈üar…ôtl…ôm…ôk ist…ôyirsiniz?")) return;
        database.ref('ads/' + id).remove().then(() => {
            alert("Elan silindi!");
            closeModal('detailModal');
        });
    }

    window.openHotPayment = function(adId) {
        currentHotAdId = adId;
        openModal('hotPaymentModal');
    }

    window.purchaseHot = function(adId, hours, price) {
        const ad = allAds.find(a => a.id === adId);
        if (!ad) return alert("Elan tapƒ±lmadƒ±!");
        
        alert(`HOT xidm…ôti aktivl…ô≈üdirildi (${hours} saat)!\nüí∞ Qiym…ôt: ${price}‚Çº\n\nReal √∂d…ôni≈ü sistemi deyildir (simulyasiya).`);
        
        database.ref('ads/' + adId).update({
            isHot: true,
            hotExpire: new Date().getTime() + (hours * 60 * 60 * 1000)
        });
        closeModal('hotPaymentModal');
    }

    window.showAdDetail = function(adId) {
        const ad = allAds.find(a => a.id === adId);
        if (!ad) return;

        let imgsHTML = "";
        ad.images.forEach((img, idx) => {
            imgsHTML += `<img src="${img}" class="slider-img ${idx === 0 ? 'active' : ''}" data-idx="${idx}" style="width:100%; border-radius:12px; margin-bottom:15px;">`;
        });

        let actionBtns = `
            <button class="btn btn-glass" onclick="warningSeller('${ad.wp}', '${ad.title}', '${ad.sellerId}')">Satƒ±cƒ±ya Yaz</button>
            <button class="btn btn-gold" onclick="contactAraci('${ad.id}', '${ad.wp}', '${ad.title}', '${ad.price}', '${ad.sellerId}')">Aracƒ± il…ô Al</button>
        `;

        if (currentUser.id === ad.sellerId) {
            actionBtns = `
                <button class="btn btn-primary" onclick="openHotPayment('${ad.id}')">üí∞ HOT Et</button>
                <button class="btn btn-danger" onclick="markAsSold('${ad.id}')">‚úÖ Satƒ±ldƒ±</button>
                <button class="btn btn-glass" onclick="deleteAd('${ad.id}')">‚ùå Sil</button>
            `;
        }

        document.getElementById('detail-content').innerHTML = `
            <div style="margin-bottom:15px;">
                <div style="background:#2c2c2e; border-radius:12px; padding:15px; margin-bottom:15px;">
                    <h2 style="margin:0; margin-bottom:10px;">${ad.title}</h2>
                    <div style="font-size:24px; color:#30D158; font-weight:bold; margin-bottom:10px;">${ad.price} AZN</div>
                    <p style="margin:5px 0; color:#aaa;"><strong>Kateqoriya:</strong> ${ad.cat}</p>
                    <p style="margin:5px 0; color:#aaa;"><strong>Satƒ±cƒ±:</strong> <span onclick="showUserProfile('${ad.sellerId}')" style="cursor:pointer; color:#0A84FF;">${ad.sellerName}</span> ${ad.sellerVerified ? '<i class="fas fa-check-circle verified-icon"></i>' : ''}</p>
                    <p style="margin:5px 0; color:#aaa;"><strong>WhatsApp:</strong> ${ad.wp}</p>
                </div>
                <h4>üì∏ ≈û…ôkill…ôr</h4>
                <div id="detail-slider" style="position:relative;">
                    ${imgsHTML}
                    ${ad.images.length > 1 ? `
                        <button class="slider-btn prev-btn" onclick="slideImage('detail-slider', -1)"><i class="fas fa-chevron-left"></i></button>
                        <button class="slider-btn next-btn" onclick="slideImage('detail-slider', 1)"><i class="fas fa-chevron-right"></i></button>
                    ` : ''}
                </div>
                <h4 style="margin-top:15px;">üìù M…ôlumat</h4>
                <p style="color:#aaa; line-height:1.6;">${ad.desc}</p>
            </div>
            <div class="action-row">
                ${actionBtns}
            </div>
        `;

        openModal('detailModal');
    }

    window.showUserProfile = function(userId) {
        const userAds = allAds.filter(a => a.sellerId === userId && !a.isSold);
        const sellerInfo = userAds.length > 0 ? userAds[0] : null;
        
        if (!sellerInfo) return alert("ƒ∞stifad…ô√ßi m…ôlumatƒ± yoxdur!");

        let adsListHTML = "";
        userAds.forEach(ad => {
            adsListHTML += `<div style="padding:8px; background:#2c2c2e; margin:5px 0; border-radius:8px; cursor:pointer;" onclick="showAdDetail('${ad.id}')">${ad.title} - ${ad.price} AZN</div>`;
        });

        document.getElementById('profile-content').innerHTML = `
            <div class="user-profile">
                <h3>üë§ ${sellerInfo.sellerName}</h3>
                <p><strong>ID:</strong> #${userId}</p>
                <p><strong>Elanlar:</strong> ${userAds.length}</p>
                <p><strong>Verified:</strong> ${sellerInfo.sellerVerified ? '‚úÖ B…ôli' : '‚ùå Xeyr'}</p>
            </div>
            <h4>üì± Payla≈üdƒ±ƒüƒ± Elanlar:</h4>
            ${adsListHTML || '<p style="color:#aaa;">Elan yoxdur</p>'}
        `;

        openModal('userProfileModal');
    }

    window.searchUser = function() {
        const query = document.getElementById('search-user').value.trim();
        if (query.length === 0) {
            renderAds(allAds);
            return;
        }
        
        const results = allAds.filter(ad => ad.sellerId === query && !ad.isSold);
        if (results.length === 0) {
            alert("Bu ID'y…ô aid elan tapƒ±lmadƒ±!");
            return;
        }
        
        renderAds(results);
    }

    window.searchUserById = function(userId) {
        document.getElementById('search-user').value = userId;
        searchUser();
        showUserProfile(userId);
    }

    window.openBanModal = function(userId) {
        document.getElementById('ban-user-id').value = userId;
        openModal('banReasonModal');
    }

    window.confirmBanUser = function() {
        if (!currentUser.isAdmin) return alert("Yalnƒ±z admin!");
        
        const userId = document.getElementById('ban-user-id').value;
        const reason = document.getElementById('ban-reason').value;

        if (!userId || !reason) return alert("B√ºt√ºn xanalarƒ± doldurun!");
        
        const ad = allAds.find(a => a.sellerId === userId);
        if (!ad) return alert("ƒ∞stifad…ô√ßi tapƒ±lmadƒ±!");

        const userIP = 'IP_' + userId;
        const banId = Date.now().toString();
        
        database.ref('bans/' + banId).set({
            ip: userIP,
            userId: userId,
            reason: reason,
            bannedAt: new Date().toISOString()
        }).then(() => {
            alert(`${userId} ID'li istifad…ô√ßi banlandƒ±!`);
            closeModal('banReasonModal');
            document.getElementById('ban-user-id').value = "";
            document.getElementById('ban-reason').value = "";
        });
    }

    window.showBanList = function() {
        if (!currentUser.isAdmin) return alert("Yalnƒ±z admin!");
        
        let banHTML = "";
        if (bannedIPs.length === 0) {
            banHTML = '<p style="color:#aaa;">Banlƒ± istifad…ô√ßi yoxdur</p>';
        } else {
            bannedIPs.forEach((ban) => {
                banHTML += `
                    <div style="background:#2c2c2e; padding:12px; margin:10px 0; border-radius:8px;">
                        <p style="margin:5px 0; color:#FFD700;"><strong>ID:</strong> ${ban.userId}</p>
                        <p style="margin:5px 0; color:#aaa;"><strong>S…ôb…ôb:</strong> ${ban.reason}</p>
                        <p style="margin:5px 0; font-size:11px; color:#666;">Ban Tarixi: ${new Date(ban.bannedAt).toLocaleDateString('az-AZ')}</p>
                        <button class="btn-mini" onclick="removeBan('${ban.ip}')">üîì √áƒ±xart</button>
                    </div>
                `;
            });
        }

        document.getElementById('ban-list-content').innerHTML = banHTML;
        openModal('banListModal');
    }

    window.removeBan = function(ip) {
        if (!confirm("Bu ban'ƒ± √ßƒ±xartmaq ist…ôyirsiniz?")) return;
        const banToRemove = bannedIPs.find(b => b.ip === ip);
        if (banToRemove) {
            database.ref('bans').orderByChild('ip').equalTo(ip).once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    database.ref('bans/' + childSnapshot.key).remove();
                });
                showBanList();
            });
        }
    }

    function toggleAdminPanel() {
        if (currentUser.isAdmin) {
            showBanList();
        } else {
            document.getElementById('admin-login-box').style.display = 'flex';
        }
    }

    function closeAdminLogin() { 
        document.getElementById('admin-login-box').style.display = 'none'; 
    }

    window.attemptAdminLogin = function() {
        const name = document.getElementById('login-name').value;
        const pass = document.getElementById('login-pass').value;

        if (name === 'Adm19' && pass === 'said01') {
            currentUser.name = "Adm19";
            currentUser.isAdmin = true;
            currentUser.isVerified = true;
            localStorage.setItem('caspian_user_local', JSON.stringify(currentUser));
            alert("Xo≈ü g…ôldin, Admin!");
            closeAdminLogin();
            updateUserUI();
            renderAds(allAds);
        } else {
            alert("S…ôhv m…ôlumat!");
        }
    }

    window.openModal = (id) => document.getElementById(id).style.display = 'flex';
    window.closeModal = (id) => document.getElementById(id).style.display = 'none';

    document.addEventListener('click', function(e) {
        const modals = document.querySelectorAll('.modal-overlay');
        modals.forEach(modal => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
</script>
</body>
</html>
