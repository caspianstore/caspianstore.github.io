<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caspian Store | Ultimate</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #000000;
            --card: #1c1c1e;
            --primary: #0A84FF;
            --accent: #30D158;
            --danger: #FF453A;
            --gold: #FFD700;
            --text: #FFFFFF;
            --text-sec: #8E8E93;
            --glass: rgba(28, 28, 30, 0.85);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
            margin: 0;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(10, 132, 255, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(10, 132, 255, 0); } 100% { box-shadow: 0 0 0 0 rgba(10, 132, 255, 0); } }

        /* HEADER */
        header {
            position: fixed; top: 0; left: 0; right: 0;
            padding: 15px 20px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            z-index: 100; border-bottom: 0.5px solid #333;
            display: flex; flex-direction: column; gap: 10px;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; background: linear-gradient(to right, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* SEARCH BAR */
        .search-container { position: relative; width: 100%; }
        .search-input {
            width: 100%; background: #2c2c2e; border: none; padding: 10px 40px 10px 15px;
            border-radius: 10px; color: white; font-size: 14px;
        }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #666; }

        /* MAIN CONTENT */
        .container { padding: 110px 20px 20px 20px; }

        /* LOGIN OVERLAY (iOS Style) */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(15px);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
            flex-direction: column; animation: fadeIn 0.5s;
        }
        .login-box {
            background: #1c1c1e; width: 85%; padding: 30px; border-radius: 20px;
            text-align: center; border: 1px solid #333;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* CATEGORIES */
        .cat-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; }
        .cat-scroll::-webkit-scrollbar { display: none; }
        .cat-pill {
            background: #2c2c2e; padding: 8px 16px; border-radius: 20px;
            white-space: nowrap; font-size: 13px; font-weight: 600; color: #ccc;
            border: 1px solid transparent; transition: 0.3s;
        }
        .cat-pill.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* AD CARDS */
        .ad-card {
            background: var(--card); border-radius: 18px; margin-bottom: 20px;
            overflow: hidden; border: 1px solid #2c2c2e; position: relative;
            animation: fadeIn 0.6s ease;
        }
        .ad-card.hot-ad { border: 1px solid var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); }
        .hot-badge {
            position: absolute; top: 10px; right: 10px; background: var(--gold); color: black;
            font-size: 10px; padding: 4px 8px; border-radius: 10px; font-weight: 800; z-index: 2;
        }
        .verified-badge { color: #1DA1F2; margin-left: 4px; font-size: 14px; }
        
        .ad-img { width: 100%; height: 220px; object-fit: cover; background: #222; }
        .ad-content { padding: 15px; }
        .ad-price { font-size: 20px; font-weight: 700; color: var(--accent); }
        .ad-title { font-size: 17px; margin: 5px 0; font-weight: 600; display: flex; align-items: center; }
        .ad-meta { font-size: 12px; color: var(--text-sec); display: flex; justify-content: space-between; margin-bottom: 12px; }

        /* BUTTONS */
        .btn { padding: 12px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; width: 100%; margin-top: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-gold { background: linear-gradient(135deg, #FFD700, #FFA500); color: black; }
        .btn-glass { background: rgba(255,255,255,0.1); color: white; }
        .btn-danger { background: rgba(255, 69, 58, 0.2); color: var(--danger); }

        /* FAB */
        .fab {
            position: fixed; bottom: 30px; right: 20px; width: 55px; height: 55px;
            background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(10,132,255,0.4); z-index: 500; font-size: 22px; color: white;
        }

        /* MODAL */
        .sheet-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: flex-end;
        }
        .sheet-content {
            background: #1c1c1e; width: 100%; padding: 25px 20px 40px 20px;
            border-radius: 30px 30px 0 0; animation: slideDown 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) reverse; /* Up animation simulated */
            max-height: 90vh; overflow-y: auto;
        }
        
        input, select, textarea {
            width: 100%; background: #2c2c2e; border: none; padding: 15px;
            border-radius: 12px; color: white; margin-bottom: 10px; font-size: 16px;
        }
        
        .empty-state { text-align: center; padding: 50px 20px; color: #555; }
        .admin-panel { padding: 10px; background: #222; border-radius: 10px; margin-top: 10px; border: 1px solid #444; }

    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <i class="fas fa-shield-alt" style="font-size: 40px; color: var(--primary); margin-bottom: 20px;"></i>
            <h2 style="margin:0 0 10px 0;">Caspian Store</h2>
            <p style="color: #888; font-size: 13px; margin-bottom: 20px;">Davam etm…ôk √º√ß√ºn l…ôq…ôb se√ßin.</p>
            <input type="text" id="login-name" placeholder="Adƒ±nƒ±z (m…ôs: User01)" style="text-align: center;">
            <div id="admin-pass-field" style="display: none;">
                <input type="password" id="login-pass" placeholder="Admin Kodu" style="text-align: center;">
            </div>
            <button class="btn btn-primary" onclick="attemptLogin()">Giri≈ü Et</button>
        </div>
    </div>

    <div id="app" style="display: none;">
        <header>
            <div class="header-top">
                <div class="logo">CASPIAN STORE</div>
                <div style="font-size: 11px; color: var(--text-sec);" id="user-badge">ID: Loading...</div>
            </div>
            <div class="search-container">
                <input type="text" class="search-input" id="search-bar" placeholder="Axtar (Oyun adƒ±, ID, s√∂z...)" onkeyup="handleSearch()">
                <i class="fas fa-search search-icon"></i>
            </div>
        </header>

        <div class="container">
            <div class="cat-scroll">
                <div class="cat-pill active" onclick="filterAds('all', this)">B√ºt√ºn</div>
                <div class="cat-pill" onclick="filterAds('Pubg', this)">Pubg</div>
                <div class="cat-pill" onclick="filterAds('Black Russia', this)">Black Russia</div>
                <div class="cat-pill" onclick="filterAds('Free Fire', this)">Free Fire</div>
                <div class="cat-pill" onclick="filterAds('Instagram', this)">Instagram</div>
                <div class="cat-pill" onclick="filterAds('TikTok', this)">TikTok</div>
            </div>

            <h3 style="opacity: 0.7; margin-bottom: 15px;">Son Elanlar</h3>
            <div id="ads-list">
                <div class="empty-state">
                    <i class="fas fa-spinner fa-spin"></i> Y√ºkl…ônir...
                </div>
            </div>
        </div>

        <div class="fab" onclick="openModal('addModal')"><i class="fas fa-plus"></i></div>

        <div id="admin-tools-modal" class="sheet-modal">
            <div class="sheet-content">
                <h3>Admin ƒ∞dar…ôetm…ô</h3>
                <input type="text" id="admin-target-id" placeholder="ƒ∞stifad…ô√ßi ID-si yaz">
                <button class="btn btn-primary" onclick="adminAction('verify')">Mavi Tik Ver</button>
                <button class="btn btn-danger" onclick="adminAction('ban')">Bu ID-ni BAN et</button>
                <button class="btn btn-glass" onclick="closeModal('admin-tools-modal')">Baƒüla</button>
            </div>
        </div>

        <div id="addModal" class="sheet-modal">
            <div class="sheet-content">
                <div style="width:40px; height:5px; background:#444; margin:0 auto 20px auto; border-radius:10px;"></div>
                <h2 style="margin-top:0">Yeni Elan</h2>
                <select id="new_cat">
                    <option value="Pubg">Pubg Mobile</option>
                    <option value="Black Russia">Black Russia</option>
                    <option value="Free Fire">Free Fire</option>
                    <option value="Brawl Stars">Brawl Stars</option>
                    <option value="Instagram">Instagram</option>
                    <option value="TikTok">TikTok</option>
                </select>
                <input type="text" id="new_title" placeholder="Ba≈ülƒ±q (m…ôs: 70 lvl, Full set)">
                <input type="number" id="new_price" placeholder="Qiym…ôt (AZN)">
                <input type="tel" id="new_wp" placeholder="WhatsApp (m…ôs: 0501234567)">
                <textarea id="new_desc" rows="3" placeholder="Hesab haqqƒ±nda m…ôlumat..."></textarea>
                
                <label style="color: #aaa; font-size: 13px; margin-left: 5px;">Elan ≈û…ôkli se√ßin:</label>
                <input type="file" id="new_img_file" accept="image/*" style="padding: 10px;">
                <p id="upload-status" style="font-size: 12px; color: var(--accent); display:none;">≈û…ôkil y√ºkl…ônir...</p>

                <button class="btn btn-primary" onclick="uploadAndPublish()">Payla≈ü</button>
                <button class="btn btn-glass" onclick="closeModal('addModal')">L…ôƒüv et</button>
            </div>
        </div>
    </div>

    <script type="module">
        // -------------------------------------------------------------
        // Dƒ∞QQ∆èT: A≈ûAƒûIDAKƒ∞ KODLARI √ñZ FIREBASE KODLARINLA D∆èYƒ∞≈û!
        // -------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, where, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "SENIN_API_KEY_KODUN",
            authDomain: "SENIN_PROJECT.firebaseapp.com",
            projectId: "SENIN_PROJECT_ID",
            storageBucket: "SENIN_PROJECT.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- GLOBAL VARIABLES ---
        let currentUser = null;
        let allAds = [];

        // --- 1. USER SYSTEM & LOGIN ---
        window.attemptLogin = async function() {
            const nameInput = document.getElementById('login-name');
            const passInput = document.getElementById('login-pass');
            const name = nameInput.value.trim();

            if (!name) return alert("Adƒ±nƒ±zƒ± yazƒ±n!");

            // Admin Check
            if (name === "Adm19") {
                document.getElementById('admin-pass-field').style.display = 'block';
                if (passInput.value !== "said01") {
                    return; // Pass wait
                }
            }

            // Generate or Load ID
            let storedId = localStorage.getItem('caspian_uid');
            if (!storedId) {
                storedId = Math.floor(10000 + Math.random() * 90000).toString();
                localStorage.setItem('caspian_uid', storedId);
            }

            // Check Ban Status form Firebase
            const userRef = doc(db, "users", storedId);
            const userSnap = await getDoc(userRef);

            let isAdmin = (name === "Adm19" && passInput.value === "said01");
            let isVerified = false;

            if (userSnap.exists()) {
                const data = userSnap.data();
                if (data.banned) {
                    alert("Sƒ∞Zƒ∞N IP BLOKLANIB! (ID: " + storedId + ")");
                    return;
                }
                isVerified = data.verified || false;
            } else {
                // Save new user
                await setDoc(userRef, {
                    name: name,
                    id: storedId,
                    joined: new Date(),
                    banned: false,
                    verified: false,
                    isAdmin: isAdmin
                });
            }

            currentUser = { name, id: storedId, isAdmin, verified: isVerified };
            
            // UI Update
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('user-badge').innerHTML = `
                <span onclick="${isAdmin ? "openModal('admin-tools-modal')" : ""}">${currentUser.name} | #${currentUser.id} ${currentUser.verified ? '<i class="fas fa-check-circle verified-badge"></i>' : ''}</span>
            `;

            loadAdsFromFirebase();
        }

        // --- 2. FIREBASE ADS SYSTEM ---
        
        // ≈û…ôkil Y√ºkl…ô v…ô Elan Payla≈ü
        window.uploadAndPublish = async function() {
            const fileInput = document.getElementById('new_img_file');
            const file = fileInput.files[0];
            
            if (!file) { alert("≈û…ôkil se√ßin!"); return; }

            document.getElementById('upload-status').style.display = 'block';
            
            try {
                // 1. ≈û…ôkli Storage-a y√ºkl…ô
                const storageRef = ref(storage, 'ads_images/' + Date.now() + '_' + file.name);
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);

                // 2. Elanƒ± Database-…ô yaz
                const adData = {
                    cat: document.getElementById('new_cat').value,
                    title: document.getElementById('new_title').value,
                    price: document.getElementById('new_price').value,
                    wp: document.getElementById('new_wp').value,
                    desc: document.getElementById('new_desc').value,
                    img: downloadURL,
                    sellerId: currentUser.id,
                    sellerName: currentUser.name,
                    sellerVerified: currentUser.verified, // Mavi tik statusu elana yapƒ±≈üƒ±r
                    date: Date.now(),
                    isHot: false,
                    hotUntil: 0
                };

                await addDoc(collection(db, "ads"), adData);
                
                alert("Elan uƒüurla payla≈üƒ±ldƒ±!");
                closeModal('addModal');
                document.getElementById('upload-status').style.display = 'none';
                loadAdsFromFirebase(); // Yenil…ô

            } catch (error) {
                console.error("Error:", error);
                alert("X…ôta ba≈ü verdi: " + error.message);
                document.getElementById('upload-status').style.display = 'none';
            }
        }

        // Elanlarƒ± G…ôtir
        async function loadAdsFromFirebase() {
            const container = document.getElementById('ads-list');
            container.innerHTML = '<div class="empty-state"><i class="fas fa-sync fa-spin"></i> Yenil…ônir...</div>';

            const q = query(collection(db, "ads"), orderBy("date", "desc"));
            const querySnapshot = await getDocs(q);
            
            allAds = [];
            querySnapshot.forEach((doc) => {
                allAds.push({ uid: doc.id, ...doc.data() });
            });

            renderAds(allAds);
        }

        window.renderAds = function(adsArray) {
            const container = document.getElementById('ads-list');
            if (adsArray.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>Bura bo≈üdur.</h3><p>H…ôl…ô ki, he√ß bir elan yoxdur.</p></div>';
                return;
            }

            container.innerHTML = '';

            adsArray.forEach(ad => {
                // Hot Status Check
                let isHot = ad.isHot && ad.hotUntil > Date.now();
                let hotClass = isHot ? 'hot-ad' : '';
                let hotBadge = isHot ? '<div class="hot-badge">üî• HOT</div>' : '';

                // Admin Controls
                let adminControls = '';
                if (currentUser.isAdmin) {
                    adminControls = `
                        <div class="admin-panel">
                            <button class="btn-mini" onclick="deleteAd('${ad.uid}')" style="color:red">Sil</button>
                            <button class="btn-mini" onclick="makeHot('${ad.uid}', 24)" style="color:orange">üî• 24s</button>
                        </div>
                    `;
                } else if (currentUser.id == ad.sellerId) {
                    adminControls = `<button class="btn btn-danger" style="margin-top:10px" onclick="deleteAd('${ad.uid}')">Elanƒ± Sil</button>`;
                }

// Verified Badge
let verifiedIcon = ad.sellerVerified ? 
'<i class="fas fa-check-circle verified-badge" title="T…ôsdiql…ônmi≈ü Satƒ±cƒ±"></i>' : '';

container.innerHTML += `
    <div class="ad-card ${hotClass}">
        ${hotBadge}
        <img src="${ad.img}" class="ad-img" loading="lazy">
        <div class="ad-content">
            <div class="ad-meta">
                <span>${ad.cat}</span>
                <span>ID: #${ad.sellerId}</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 class="ad-title">${ad.title}</h3>
                <div class="ad-price">${ad.price} AZN</div>
            </div>
            <p style="font-size:13px; color:#aaa;">Satƒ±cƒ±: ${ad.sellerName} ${verifiedIcon}</p>
            
            <div style="display:flex; gap:10px;">
                <button class="btn btn-glass" onclick="window.open('https://wa.me/${ad.wp}')">Satƒ±cƒ±ya Yaz</button>
                <button class="btn btn-gold" onclick="contactAraci('${ad.uid}', '${ad.wp}')">Aracƒ± il…ô Al</button>
            </div>
            ${adminControls}
        </div>
    </div>
`;

// --- 3. HELPER FUNCTIONS ---

window.handleSearch = function() {
    const query = document.getElementById('search-bar').value.toLowerCase();
    const filtered = allAds.filter(ad => 
        ad.title.toLowerCase().includes(query) || 
        ad.sellerId.toString().includes(query) ||
        ad.cat.toLowerCase().includes(query)
    );
    renderAds(filtered);
}

window.filterAds = function(cat, element) {
    document.querySelectorAll('.cat-pill').forEach(el => el.classList.remove('active'));
    element.classList.add('active');

    if (cat === 'all') {
        renderAds(allAds);
    } else {
        const filtered = allAds.filter(ad => ad.cat === cat);
        renderAds(filtered);
    }
}

// --- 4. ADMIN & ACTION FUNCTIONS ---

window.deleteAd = async function(docId) {
    if(!confirm("Silm…ôk ist…ôyirs…ôn?")) return;
    await deleteDoc(doc(db, "ads", docId));
    loadAdsFromFirebase();
}

window.makeHot = async function(docId, hours) {
    const until = Date.now() + (hours * 60 * 60 * 1000);

    await updateDoc(doc(db, "ads", docId), {
        isHot: true,
        hotUntil: until
    });
    alert("Elan HOT edildi!");
    loadAdsFromFirebase();
}

                             window.adminAction = async function(action) {
    const targetId = document.getElementById('admin-target-id').value;
    if(!targetId) return alert("ID daxil et!");

    const userRef = doc(db, "users", targetId);

    if (action === 'verify') {
        await updateDoc(userRef, { verified: true });
        alert("ƒ∞stifad…ô√ßi T…ôsdiql…ôndi (Mavi Tik)!");
    } else if (action === 'ban') {
        await updateDoc(userRef, { banned: true });
        alert("ƒ∞stifad…ô√ßi BANLANDI!");
    }
    closeModal('admin-tools-modal');
}

window.contactAraci = function(id, sellerWp) {
    window.open(`https://wa.me/994771048394?text=Salam, Elan ID: ${id} almaq isteyirem.`, '_blank');
}

// UI Modals
window.openModal = (id) => { 
    document.getElementById(id).style.display = 'flex'; 
}
window.closeModal = (id) => { 
    document.getElementById(id).style.display = 'none'; 
}

// Expose functions globally for HTML onclick (Module scope fix)
window.loadAdsFromFirebase = loadAdsFromFirebase;

                </script>

    </body>
    </html>
